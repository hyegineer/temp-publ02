<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Box Plot</title>

</head>

<style>
  .survival_container1 {
    display: flex;
    flex-direction: column;
    height: 76vh;
  }

  .survival_box1,
  .survival_box2 {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .survival_flex-hori {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .survival_char-div {
    width: 50%;
    height: 38vh;
  }
</style>

<body>
  <div class="layerPopup">
    <div class="spinner"></div>
  </div>
  <div style="display: flex;margin: auto;">

    <div style="display: flex;margin: auto;">
      <div style="width: 300px;">
        <select id="survival_select-tools" multiple placeholder="Target"></select>
      </div>
      <button id="survival_apply-btn" type="button" class="btn btn-primary" style="margin-left: 10px;">
        Apply
      </button>
      <!-- <button id="survival_sort-btn" type="button" class="btn btn-primary" style="margin-left: 10px;">
        SortBy
      </button> -->
      <div style="width: 120px;margin-left: 10px;">
        <select id="survival_select-tools2" multiple placeholder="Sort by"></select>
      </div>
    </div>
  </div>

  <div class="survival_container1">
    <!-- <div class="box1">
      <div id="myDiv0" class="char-div"></div>
      <div id="myDiv1" class="char-div"></div>
    </div>

    <div class="box2">
      <div id="myDiv2" class="char-div"></div>
      <div id="myDiv3" class="char-div"></div>
    </div> -->

  </div>

  <!-- <div class="flex-hori">
    <div id="page-index"></div>
  </div>

  <div class="flex-hori">
    <button id="pre-btn" type="button" class="btn btn-primary">
      Pre
    </button>
    <button id="next-btn" type="button" class="btn btn-primary" style="margin-left: 10px;">
      Next
    </button>
  </div> -->


  <script>
    
    var container = document.getElementsByClassName('survival_container1')
    var $select = $('#survival_select-tools').selectize({
      plugins: ["remove_button"],
      maxItems: 1,
      maxOptions: 100,
      valueField: 'id',
      labelField: 'title',
      searchField: 'title',
      options: [],
      create: false,
    });
    var $select2 = $('#survival_select-tools2').selectize({
      plugins: ["remove_button"],
      maxItems: 1,
      maxOptions: 2,
      valueField: 'id',
      labelField: 'title',
      searchField: 'title',
      options: [],
      create: false
    });

    var sortOptions = []
    /*var selectizeControl2 = $select2[0].selectize;
    sortOptions.push({ id: 1, title: 'P-Value' })
    sortOptions.push({ id: 2, title: 'Gene Name' })
    selectizeControl2.addOption(sortOptions);
    selectizeControl2.on('change', function (value) {
      if (value[0] === '1') {
        sortKey = 1
        draw(res, allLayout, allPvalue)
      } else if (value[0] === '2') {
        sortKey = 2
        draw(res, allLayout, allPvalue)
      }
    });*/

    var allUniqueValue = new Map();
    var allPatient = new Map();
    var proteinPatient = []
    var genePatient = []
    var acetlysitePatient = []
    var phosphositePatient = []
    var allProtein = new Map();
    var allGene = new Map();
    var allAcetlysite = new Map();
    var allPhosphosite = new Map();
    var patientInfo = [];
    var targetOptions = []
    var index = 1
    var sort_value = 0
    result_array = []
    var processed = 0
    var prev_protein = ''

    function getData() {
      showSpinner();
      const patientData = metaArray;
      const rowHeader = [];
      patientData.map((row) => {
        const rowData = row.split(",");
        rowHeader.push(rowData[0]);
        let uniqueValue = unique(rowData.slice(1));
        allUniqueValue.set(rowData[0], uniqueValue);
      });
      allUniqueValue.delete('Sample.ID');
      allUniqueValue.delete('Subtype Membership');
      allUniqueValue.delete('Age');

      //console.log(allUniqueValue)
      //console.log(patientData)
      //get patientInfo
      for (let i = 1; i < patientData[0].split(",").length; i++) {
        patientInfo.push(new PatientMetaData());
      }
      for (let i = 0; i < rowHeader.length; i++) {
        let row = patientData[i].split(",").slice(1)
        for (let j = 0; j < row.length; j++) {
          patientInfo[j][rowHeader[i]] = row[j];
        }
      }
      patientInfo.forEach((value) => {
        allPatient.set(value['Sample.ID'], value)
      });
      //console.log(allPatient)

      $.ajax({
        type: "GET",
        url: baseURL + "/file/Quantitation_proteins.csv",
        dataType: "text",
        cache: false,
        success: function (data) {
          data = data.split("\n");
          proteinPatient = data[0].split(",").slice(2);
          for (let i = 1; i < data.length; i++) {
            const row = data[i].split(",")
            allProtein.set(row[0], row.slice(2))
          }
          //"RE-P231-T\r"
          let last = proteinPatient[proteinPatient.length - 1]
          proteinPatient[proteinPatient.length - 1] = last.substring(0, last.length - 1)
          
          // console.log(proteinPatient)
          // console.log(allProtein)
          for (const key of allProtein.keys()) {
            targetOptions.push({ id: index, title: key })
            index++;
          }
          //console.log(allProtein)
          $.ajax({
            type: "GET",
            url: baseURL + "/file/Quantitation_acetyl.csv",
            dataType: "text",
            cache: false,
            success: function (data) {
              data = data.split("\n");
              acetlysitePatient = data[0].split(",").slice(2);
              for (let i = 1; i < data.length; i++) {
                const row = data[i].split(",")
                allAcetlysite.set(row[0], row.slice(2))
                allAcetlysite.set(row[2], row.slice(2))
              }
              //"RE-P231-T\r"
              let last = acetlysitePatient[acetlysitePatient.length - 1]
              acetlysitePatient[acetlysitePatient.length - 1] = last.substring(0, last.length - 1)
              
              // console.log(acetlysitePatient)
              // console.log(allAcetlysite)
              for (const key of allAcetlysite.keys()) {
                targetOptions.push({ id: index, title: key })
                index++;
              }

              $.ajax({
                type: "GET",
                url: baseURL + "/file/Quantitation_phospho.csv",
                dataType: "text",
                cache: false,
                success: function (data) {
                  data = data.split("\n");
                  phosphositePatient = data[0].split(",").slice(2);
                  for (let i = 1; i < data.length; i++) {
                    const row = data[i].split(",")
                    allPhosphosite.set(row[0], row.slice(2))
                    allPhosphosite.set(row[2], row.slice(2))
                  }
                  let last = phosphositePatient[phosphositePatient.length - 1]
                  phosphositePatient[phosphositePatient.length - 1] = last.substring(0, last.length - 1)
                  
                  // console.log(phosphositePatient)
                  // console.log(allPhosphosite)
                  for (const key of allPhosphosite.keys()) {
                    targetOptions.push({ id: index, title: key })
                    index++;
                  }
                  //console.log(allPhosphosite)
                  $.ajax({
                    type: "GET",
                    url: baseURL + "/file/Quantitation_genes.csv",
                    dataType: "text",
                    cache: false,
                    success: function (data) {
                      data = data.split("\n");
                      genePatient = data[0].split(",").slice(1);
                      for (let i = 1; i < data.length; i++) {
                        const row = data[i].split(",")
                        allGene.set(row[0], row.slice(1))
                      }
                      //去除多余空值
                      genePatient = genePatient.slice(0, genePatient.indexOf(''))
                      // console.log(genePatient)
                      // console.log(allGene)
                      for (const key of allGene.keys()) {
                        targetOptions.push({ id: index, title: key })
                        index++;
                      }

                      let groupOptions = []
                      index = 1
                      for (const key of allUniqueValue.keys()) {
                        groupOptions.push({ id: index, title: key })
                        index++;
                      }
                      var selectizeControl = $select[0].selectize;
                      selectizeControl.addOption(targetOptions)
                      hideSpinner()
                      //console.log(targetOptions)
                    },

                  });
                },
              });
            },
          });
        },
      });
    }
    
    getData()



    function unique(array) {
      return array.filter((value, index, self) => {
        return value !== 'None' && value !== '' && self.indexOf(value) === index;
      });
    }

    function draw(res, target_size) {
      //let boxIndex = 0
      p_val_array = []
      var result_array = []
      for (let i = 0; i < result_array.length; i++) {
        Plotly.purge("survival_myDiv" + i)
      }
      let allKeys = Array.from(res.keys())
      //console.log("page :" + page)
      let start = page * 4
      //allKeys = allKeys.slice(start, start + 4)
      allKeys.forEach((value, index) => {
        let data = res.get(value)
        //console.log(data)
        let pValue = 0
        let pText = ""
        result_array = plot_survival(data,"survival_myDiv"+index, value, p_val_array, target_size)
        
      })
      
      /*p_val_array.sort(function(a, b){
        return parseFloat(a["p_val"]) - parseFloat(b["p_val"]);
      })*/

    }


function plot_survival(data_high_list, location, title, p_val_array, target_size){
var min_date = 0
//var max_date = d3.max(data, (d)=>d.time)
var max_date = 11

    d3.csv("http://127.0.0.1:5501/PDIAMOND/file/Overall_survivals.csv", function(raw_data){

function filterHigh(obj){
    if (data_high_list.includes(obj.sample)){
        return obj.sample;
    }
    //console.log(data_high.includes(obj.sample)) 
}

function filterLow(obj){
    if (data_high_list.includes(obj.sample)){
    }
    else{
        return obj.sample;
    }
    
    //console.log(data_high.includes(obj.sample)) 
}

//Data cleaning:
data = raw_data.map(function(d){
    var new_d = {}
    // new_d.age_entry_year = +d.ageentry/12; //patient start
    // new_d.age_year = +d.age/12;            //patient end
    new_d.time = +d.os/12
    new_d.death    = d.death  == "Y" ? true : false;
    new_d.sample = d.Sample
    return new_d;
    })
    .sort(d => d.time)
    //.filter(filterLow)

data_temp = data
data_high = data.filter(filterHigh)
data_low = data.filter(filterLow)
//console.log(data_high, data_low)
var table_high = KM_Curve(data_high);
kmsurv_high = table_high[0];
censor_high = table_high[1];

//console.log("high list =")
//console.log(data_high_list)
//console.log("kmsurv_high")
//console.log(kmsurv_high)
//console.log(censor_high)
var table_low = KM_Curve(data_low);
kmsurv_low = table_low[0]
censor_low = table_low[1]

//console.log("kmsurv_low")
//console.log(kmsurv_low)
//console.log(censor_low)

//console.log(censor_low)

kmsurv_high.unshift({"t_i": min_date, "d_i": 0, "Y_i": 0, "s_t": 0, "S_t": 1})
kmsurv_low.unshift({"t_i": min_date, "d_i": 0, "Y_i": 0, "s_t": 0, "S_t": 1})
censor_high.unshift({"c_i": min_date, "c_s": 1})
censor_low.unshift({"c_i": min_date, "c_s": 1})

data_table = log_rank_Test(data,data_high,data_low)
        //console.log(data_table)
g1 = data_table[0]
g2 = data_table[1]
for(let i = 0; i < g1.length; i++){
    g1[i].e_i = (g1[i].n_i/(g1[i].n_i + g2[i].n_i)) * (g1[i].m_i+g2[i].m_i)
    g2[i].e_i = (g2[i].n_i/(g1[i].n_i + g2[i].n_i)) * (g1[i].m_i+g2[i].m_i)
    }
        
for(let i = 0; i < g1.length; i++){
    g1[i].o_i = g1[i].m_i - g1[i].e_i
    g2[i].o_i = g2[i].m_i - g2[i].e_i
    }
        
variance = 0
for(let i = 0; i < g1.length; i++){
    if (g1[i].n_i + g2[i].n_i == 1){
        variance += 0
        }
    else{
        variance += ((g1[i].n_i*g2[i].n_i)*(g1[i].m_i + g2[i].m_i)*(g1[i].n_i+g2[i].n_i - g1[i].m_i-g2[i].m_i))/((g1[i].n_i + g2[i].n_i)*(g1[i].n_i + g2[i].n_i)*(g1[i].n_i + g2[i].n_i-1))
        }   
    //console.log(variance)
    }
        
sum_o = 0
for(let i = 0; i < g1.length; i++){
    sum_o += g2[i].o_i
    }   
        
log_rank_test_val = sum_o**2/variance
//console.log(g1)
//console.log(log_rank_test_val)
        //import myModule from './my-module';
p_val = ChiSq(log_rank_test_val, 1).toFixed(4)
//console.log(p_val)


trace1 = {
  x: kmsurv_high.map((item) => item.t_i*12),
  y: kmsurv_high.map((item) => item.S_t),
  mode: 'lines',
  name: 'high',
  
  line: {shape: 'hv', color: 'red'},
};

trace2 = {
  x: kmsurv_low.map((item) => item.t_i*12),
  y: kmsurv_low.map((item) => item.S_t),
  mode: 'lines',
  name: 'low',
  
  line: {shape: 'hv', color: 'blue'},
};

trace3 = {
  x: censor_low.map((item) => item.c_t*12),
  y: censor_low.map((item) => item.c_s),
  mode: 'markers',
  
  marker: { size: 6, color: 'blue', symbol : 142 },
  showlegend :false
}
trace4 = {
  x: censor_high.map((item) => item.c_t*12),
  y: censor_high.map((item) => item.c_s),
  mode: 'markers',
  marker: { size: 6, color: 'red', symbol : 142 },
  showlegend :false
}

var data = [trace1, trace2, trace3, trace4];

var layout = {
    title : {
        text : title+ "<br>P-value = " + p_val,
    },

   yaxis:{
        autotick: false,
        ticks: 'outside',
        tick0: 0,
        dtick: 0.25,
        range : [0,1]
    },
  xaxis :{
    title :'month'
  },
  legend: {
    autosize : false,
    font: {size: 16},
    yref: 'paper',
    title : p_val
  }};


p_val_array.push({"title" : title, "location" : location, "data" : data, "layout" : layout, "p_val" :p_val})
//console.log(p_val_array)
//Plotly.newPlot(location, data, layout);
result_array = p_val_array
console.log(p_val_array)
if(p_val_array.length == target_size){
  if(sort_value == 1){
    p_val_array = p_val_array.sort(function(a, b){
      return parseFloat(a["p_val"]) - parseFloat(b["p_val"]);
    })
    let boxIndex = 0
      for(let i = 0; i < p_val_array.length; i ++){
        if ((boxIndex & 1) === 0) {
          let newBox = $('<div class="survival_box"></div>');
          newBox.attr('id', `survival_box${Math.floor(boxIndex / 2)}`);
          charDiv = $('<div class="survival_char-div"></div>');
          charDiv.attr('id', `survival_myDiv${boxIndex}`);
          newBox.append(charDiv);
          $('.survival_container1').append(newBox);
        } else {
          let newBox = $('#survival_box' + Math.floor(boxIndex / 2))
          charDiv = $('<div class="survival_char-div"></div>');
          charDiv.attr('id', `survival_myDiv${boxIndex}`);
          newBox.append(charDiv);
        }
        Plotly.newPlot("survival_myDiv"+boxIndex, p_val_array[i].data, p_val_array[i].layout);
        boxIndex++;
      }
  }
  else{
    let boxIndex = 0
      for(let i = 0; i < p_val_array.length; i ++){
        if ((boxIndex & 1) === 0) {
          let newBox = $('<div class="survival_box"></div>');
          newBox.attr('id', `survival_box${Math.floor(boxIndex / 2)}`);
          charDiv = $('<div class="survival_char-div"></div>');
          charDiv.attr('id', `survival_myDiv${boxIndex}`);
          newBox.append(charDiv);
          $('.survival_container1').append(newBox);
        } else {
          let newBox = $('#survival_box' + Math.floor(boxIndex / 2))
          charDiv = $('<div class="survival_char-div"></div>');
          charDiv.attr('id', `survival_myDiv${boxIndex}`);
          newBox.append(charDiv);
        }
        Plotly.newPlot("survival_myDiv"+boxIndex, p_val_array[i].data, p_val_array[i].layout);
        boxIndex++;
      }
  }
}




function KM_Curve(data){
    //Source http://stackoverflow.com/questions/11246758/how-to-get-unique-values-in-an-array
    Array.prototype.contains = function(v) {
        for(var i = 0; i < this.length; i++) {
            if(this[i] === v) return true;
        }
        return false;
    };
    Array.prototype.unique = function() {
        var arr = [];
        for(var i = 0; i < this.length; i++) {
            if(!arr.contains(this[i])) {
                arr.push(this[i]);
            }
        }
        return arr;
    }

    //get unique times of death.
    var death_times = data.filter(d => d.death)
        .map(d => d.time)
        .sort()
    var censored_times = data.filter(d => !d.death)
        .map(d => parseFloat(d.time))
        //censored_times = censored_times.map(v=>parseFloat(v))
    
    var censored_times_sorted = censored_times.sort(function(a, b)  {
        return a - b;
        });
    
    var km_table = death_times.map(t_i => {
        var d_i = data.filter(d => d.time == t_i && d.death).length

        var Y_i = data.filter(d => d.time >= t_i).length

        var s_t = 1 - (d_i/Y_i);

        return {"t_i": t_i, "d_i": d_i, "Y_i": Y_i, "s_t": s_t}
    })
    
    //console.log(km_table);
    //console.log(km_table);
    

    var censor_table = []
    /*console.log("censored_time")
    console.log(censored_times)
    console.log("---------------")
    console.log("censored_time_sorted")
    console.log(censored_times_sorted)
    console.log("--------------")
    console.log("death_time")
    console.log(death_times)
    console.log("------------")
    */
    var j = 0
    var prev_km = 1
    var cur_km = 1
    //showing censored point in the plot using previous S_t
    for (let [i, row] of km_table.entries()) {
        var t = row.t_i,
            s_t = row.s_t,
            last_S_t = i != 0 ? km_table[i-1].S_t : 1;
        km_table[i].S_t = last_S_t * s_t;
        if (i>0){
            prev_km = km_table[i-1].S_t
            cur_km = km_table[i].S_t
        }
        while(true){
            if (censored_times_sorted[j]<=row.t_i){
                censor_table[j] = {"c_t" : censored_times_sorted[j], "c_s" : last_S_t}
                j ++;
            }
            else{
                break
            }
        }
    }
    //console.log(censor_table)
    for(let i = j; i < censored_times_sorted.length; i++){
        censor_table[i] = {"c_t" : censored_times_sorted[i], "c_s" : cur_km}
    }
    //console.log(censor_table)
    //console.log(km_table)
    //console.log(censor_table)
    
    //console.log(km_table, censor_table)
    // console.table(km_table)
    km_table[km_table.length] = {"t_i": max_date, "d_i": max_date, "Y_i": max_date, "S_t": cur_km}
    return [km_table, censor_table];
}

function ChiSq(x,n) {
    if(n==1 & x>1000) {return 0}
    if(x>1000 | n>1000) {
        var q=ChiSq((x-n)*(x-n)/(2*n),1)/2
        if(x>n) {return q} {return 1-q}
        }
    var p=Math.exp(-0.5*x); if((n%2)==1) { p=p*Math.sqrt(2*x/Pi) }
    var k=n; while(k>=2) { p=p*x/k; k=k-2 }
    var t=p; var a=n; while(t>0.0000000001*p) { a=a+2; t=t*x/a; p=p+t }
    return 1-p
    }

function log_rank_Test(data,high,low){

    death_times_high = high.filter(d => d.death)
        .map(d => d.time)
        .sort()
    death_times_low = low.filter(d => d.death)
        .map(d => d.time)
        .sort()
    
    censored_times_high = high.filter(d => !d.death)
        .map(d => parseFloat(d.time))
        //censored_times = censored_times.map(v=>parseFloat(v))
    
    censored_times_sorted_high = censored_times_high.sort(function(a, b)  {
        return a - b;
        });
    censored_times_low = low.filter(d => !d.death)
        .map(d => parseFloat(d.time))
        //censored_times = censored_times.map(v=>parseFloat(v))
    
    censored_times_sorted_low = censored_times_low.sort(function(a, b)  {
        return a - b;
        });
    prev_t = 0
    var group1 = data.map(t_i => {
        var m_i = death_times_high.filter(d => d == t_i.time).length

        var n_i = high.filter(d => d.time >= t_i.time).length
        
        var q_i = censored_times_sorted_high.filter(d=>d <= t_i.time && d.time > prev_t).length
        
        prev_t = t_i.time
        return {"t_i": t_i.time, "n_i": n_i, "m_i": m_i, "q_t": q_i}
    })
    var group2 = data.map(t_i => {
        var m_i = death_times_low.filter(d => d == t_i.time).length

        var n_i = low.filter(d => d.time >= t_i.time).length
        
        var q_i = censored_times_sorted_low.filter(d=>d <= t_i.time && d > prev_t).length
        
        prev_t = t_i.time
        return {"t_i": t_i.time, "n_i": n_i, "m_i": m_i, "q_t": q_i}
    })

    return [group1, group2]
}

})

}
    var res = new Map()
    var page = 0
    var limit = 0
    var groupValue = ""


    $("#survival_apply-btn").click(function () {
      sort_value = 0
      $(".survival_container1").empty();
      targetValue = $('#survival_select-tools').text();
      if(prev_protein == ''){
        prev_protein = targetValue
        processed = 0
      }
      else if(prev_protein == targetValue){
        processed = 1
      }
      else{
        processed = 0
      }
      if(processed == 1){
        p_val_array = result_array
        if(sort_value == 1){
          p_val_array = p_val_array.sort(function(a, b){
            return parseFloat(a["p_val"]) - parseFloat(b["p_val"]);
          })
          let boxIndex = 0
            for(let i = 0; i < p_val_array.length; i ++){
              if ((boxIndex & 1) === 0) {
                let newBox = $('<div class="survival_box"></div>');
                newBox.attr('id', `survival_box${Math.floor(boxIndex / 2)}`);
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
                $('.survival_container1').append(newBox);
              } else {
                let newBox = $('#survival_box' + Math.floor(boxIndex / 2))
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
              }
              Plotly.newPlot("survival_myDiv"+boxIndex, p_val_array[i].data, p_val_array[i].layout);
              boxIndex++;
            }
        }
        else{
          let boxIndex = 0
            for(let i = 0; i < p_val_array.length; i ++){
              if ((boxIndex & 1) === 0) {
                let newBox = $('<div class="survival_box"></div>');
                newBox.attr('id', `survival_box${Math.floor(boxIndex / 2)}`);
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
                $('.survival_container1').append(newBox);
              } else {
                let newBox = $('#survival_box' + Math.floor(boxIndex / 2))
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
              }
              Plotly.newPlot("survival_myDiv"+boxIndex, p_val_array[i].data, p_val_array[i].layout);
              boxIndex++;
            }
        }
        prev_protein = targetValue
        return 0;
      }
      if(processed ==0 ){
        processed = 1
      }

      res = new Map()
      page = 0
      groupValue = $('#survival_select-tools1').text();
      //let uniqueValue = allUniqueValue.get(groupValue);
      //uniqueValue = uniqueValue.sort()
      //console.log(uniqueValue)
      //console.log(targetValue)
      let targetArray = new Map();
      let targetPatient = new Map();
      if (allGene.has(targetValue)) {
        targetArray.set(targetValue, allGene.get(targetValue))
        targetPatient.set(targetValue, genePatient)
      }
      if (allProtein.has(targetValue)) {
        targetArray.set(targetValue, allProtein.get(targetValue))
        targetPatient.set(targetValue, proteinPatient)
      }
      //console.log(allAcetlysite)
      for (const [key, value] of allAcetlysite) {
        //console.log(key)
        if (key == null | key == "") continue;
        if (key.split("_")[0] !== targetValue) continue;
        targetArray.set(key, value.slice(1))
        targetPatient.set(key, acetlysitePatient.slice(1))
      }
      for (const [key, value] of allPhosphosite) {
        if (key == null | key == "") continue;
        if (key.split("_")[0] !== targetValue) continue;
        targetArray.set(key, value.slice(1))
        targetPatient.set(key, phosphositePatient.slice(1))
      }
      
    //   var newMap = {};
      var temp_list = []
      var iterator = targetArray.values()
      for (let i = 0 ; i < targetArray.size; i++){
        var temp = []
        var temp_array = iterator.next().value
        for(let j = 0; j < temp_array.length; j ++){
            temp.push(temp_array[j])
        }
        temp_list.push(temp)
      }
      //console.log(temp_list)
      
      //console.log(targetArray.values().next().value)
      //console.log(targetArray.length)
    //   for(let i = 0 ; i < targetArray.values().next().value.length; i++){
    //         temp.push((targetArray.values()[i], targetPatient.values()[i]))
    //   }
      
      function median(array) {
            return array.sort((a, b) => a - b)[Math.floor(array.length / 2)];
      }
      var patient_list = targetPatient.values().next().value
      //console.log(targetArray)
      //console.log(targetPatient)
      //console.log(targetArray.values())
      //console.log(temp_list)
      
      function deepCopy(obj) {
        if (typeof obj !== "object" || obj === null) {
          return obj;
        }
       
        if (obj instanceof Date) {
          return new Date(obj.getTime());
        }
       
        if (obj instanceof Array) {
          return obj.reduce((arr, item, i) => {
            arr[i] = deepCopy(item);
            return arr;
          }, []);
        }
       
        if (obj instanceof Object) {
          if (obj instanceof Set) {
            const copySet = new Set();
            obj.forEach((value) => {
              copySet.add(deepCopy(value));
            });
            return copySet;
          }
       
          if (obj instanceof Map) {
            const copyMap = new Map();
            obj.forEach((key, value) => {
              copyMap.set(deepCopy(key), deepCopy(value));
            });
            return copyMap;
          }
       
          return Object.keys(obj).reduce((newObj, key) => {
            newObj[key] = deepCopy(obj[key]);
            return newObj;
          }, {});
        }
      }
      copy = deepCopy(targetArray)
      
      var median_iter = copy.keys()
      var median1 = []
      
      for (let i = 0 ; i < targetArray.size; i++){
      
        var temp_array1 = median_iter.next().value
        median1.push(median(temp_array1))
      }
      
      //console.log(median1)
      var high = []
      for(let i = 0; i < median1.length; i++){
        var high_index = []
        for(let j = 0 ; j < temp_list[i].length; j++){
            if(parseFloat(temp_list[i][j]) >= parseFloat(median1[i])){
                //console.log(temp_list[i][j], median1[i])
                high_index.push(patient_list[j])
            }
        
        }
        high.push(high_index)
      }
      //console.log(high)
      i = 0
      //console.log(targetArray)
      for (const [key, value] of targetArray){
        let cur_target = key
        let cur_median = median1[i]
        res.set(cur_target, high[i])
        i ++ 
      }
      limit = Math.ceil(res.size / 4)
      
        draw(res,targetArray.size)
        prev_protein = targetValue
        
    })

    //click sort begin
    var sortOptions = []
    var selectizeControl2 = $select2[0].selectize;
    sortOptions.push({ id: 1, title: 'P-Value' })
    sortOptions.push({ id: 2, title: 'Gene Name' })
    selectizeControl2.addOption(sortOptions);
    selectizeControl2.on('change', function (value) {
      if (value[0] === '1') {
        sort_value = 1
      
      $(".survival_container1").empty();
      if(processed == 1){
        p_val_array = result_array
        if(sort_value == 1){
          p_val_array = p_val_array.sort(function(a, b){
            return parseFloat(a["p_val"]) - parseFloat(b["p_val"]);
          })
          let boxIndex = 0
            for(let i = 0; i < p_val_array.length; i ++){
              if ((boxIndex & 1) === 0) {
                let newBox = $('<div class="survival_box"></div>');
                newBox.attr('id', `survival_box${Math.floor(boxIndex / 2)}`);
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
                $('.survival_container1').append(newBox);
              } else {
                let newBox = $('#survival_box' + Math.floor(boxIndex / 2))
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
              }
              Plotly.newPlot("survival_myDiv"+boxIndex, p_val_array[i].data, p_val_array[i].layout);
              boxIndex++;
            }
        }
        else{
          let boxIndex = 0
            for(let i = 0; i < p_val_array.length; i ++){
              if ((boxIndex & 1) === 0) {
                let newBox = $('<div class="survival_box"></div>');
                newBox.attr('id', `survival_box${Math.floor(boxIndex / 2)}`);
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
                $('.survival_container1').append(newBox);
              } else {
                let newBox = $('#survival_box' + Math.floor(boxIndex / 2))
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
              }
              Plotly.newPlot("survival_myDiv"+boxIndex, p_val_array[i].data, p_val_array[i].layout);
              boxIndex++;
            }
        }
      }
      } else if (value[0] === '2') {
        sort_value = 1
      
      $(".survival_container1").empty();
      if(processed == 1){
        p_val_array = result_array
        if(sort_value == 1){
          p_val_array = p_val_array.sort(function(a, b){
            //debugger
            var nameA = a["title"].toUpperCase(); // ignore upper and lowercase
            var nameB = b["title"].toUpperCase(); // ignore upper and lowercase
            if (nameA < nameB) {
              return -1;
            }
            if (nameA > nameB) {
              return 1;
            }
            //return parseFloat(a["title"]) - parseFloat(b["title"]);
          })
          let boxIndex = 0
            for(let i = 0; i < p_val_array.length; i ++){
              if ((boxIndex & 1) === 0) {
                let newBox = $('<div class="survival_box"></div>');
                newBox.attr('id', `survival_box${Math.floor(boxIndex / 2)}`);
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
                $('.survival_container1').append(newBox);
              } else {
                let newBox = $('#survival_box' + Math.floor(boxIndex / 2))
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
              }
              Plotly.newPlot("survival_myDiv"+boxIndex, p_val_array[i].data, p_val_array[i].layout);
              boxIndex++;
            }
        }
        else{
          let boxIndex = 0
            for(let i = 0; i < p_val_array.length; i ++){
              if ((boxIndex & 1) === 0) {
                let newBox = $('<div class="survival_box"></div>');
                newBox.attr('id', `survival_box${Math.floor(boxIndex / 2)}`);
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
                $('.survival_container1').append(newBox);
              } else {
                let newBox = $('#survival_box' + Math.floor(boxIndex / 2))
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
              }
              Plotly.newPlot("survival_myDiv"+boxIndex, p_val_array[i].data, p_val_array[i].layout);
              boxIndex++;
            }
        }
      }
      }

    });
    /*
    $("#survival_sort-btn").click(function () {
      sort_value = 1
      
      $(".survival_container1").empty();
      if(processed == 1){
        p_val_array = result_array
        if(sort_value == 1){
          p_val_array = p_val_array.sort(function(a, b){
            return parseFloat(a["p_val"]) - parseFloat(b["p_val"]);
          })
          let boxIndex = 0
            for(let i = 0; i < p_val_array.length; i ++){
              if ((boxIndex & 1) === 0) {
                let newBox = $('<div class="survival_box"></div>');
                newBox.attr('id', `survival_box${Math.floor(boxIndex / 2)}`);
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
                $('.survival_container1').append(newBox);
              } else {
                let newBox = $('#survival_box' + Math.floor(boxIndex / 2))
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
              }
              Plotly.newPlot("survival_myDiv"+boxIndex, p_val_array[i].data, p_val_array[i].layout);
              boxIndex++;
            }
        }
        else{
          let boxIndex = 0
            for(let i = 0; i < p_val_array.length; i ++){
              if ((boxIndex & 1) === 0) {
                let newBox = $('<div class="survival_box"></div>');
                newBox.attr('id', `survival_box${Math.floor(boxIndex / 2)}`);
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
                $('.survival_container1').append(newBox);
              } else {
                let newBox = $('#survival_box' + Math.floor(boxIndex / 2))
                charDiv = $('<div class="survival_char-div"></div>');
                charDiv.attr('id', `survival_myDiv${boxIndex}`);
                newBox.append(charDiv);
              }
              Plotly.newPlot("survival_myDiv"+boxIndex, p_val_array[i].data, p_val_array[i].layout);
              boxIndex++;
            }
        }
        return 0;
      }
      
    })
    //console.log(result_array)
    //click sort end
    
    */


//survival plot end


</script>
</body>

</html>
